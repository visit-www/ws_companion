{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Saved Preferences Summary -->
    <div class="card dashboard-card mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0 text-success">üë§ Your Saved Preferences</h5>
      </div>
      <div class="card-body">
        <p><strong>Subspecialties:</strong></p>
        {% if user_profile.preferred_subspecialties %}
        {% for item in user_profile.preferred_subspecialties %}
        <span class="badge bg-primary me-1 mb-1">{{ item.value.replace('_', ' ').title() }}</span>
        {% endfor %}
        {% else %}
        <span class="text-muted">Not yet set</span>
        {% endif %}

        <hr class="my-3">

        <p><strong>Workplaces:</strong></p>
        {% if user_profile.preferred_workplaces %}
        {% for place in user_profile.preferred_workplaces %}
        <span class="badge bg-info text-dark me-1 mb-1">{{ place }}</span>
        {% endfor %}
        {% else %}
        <span class="text-muted">Not yet set</span>
        {% endif %}
      </div>
    </div>
    <!-- Preferences Panel -->
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0 text-primary">üß© Customise Your Preferences</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('app_user.save_productivity_preferences') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label for="preferred_subspecialties" class="form-label">Preferred Subspecialties</label>
              <select class="form-select" id="preferred_subspecialties" name="preferred_subspecialties" multiple>
                {% for subspecialty in [
                'head_and_neck', 'neuroradiology', 'chest', 'cardiovascular', 'breast',
                'gastrointestinal', 'abdominal', 'genitourinary', 'musculoskeletal', 'vascular',
                'pediatric', 'oncologic', 'emergency', 'interventional', 'nuclear_medicine',
                'radiographers', 'others'] %}
                <option value="{{ subspecialty }}" {% if subspecialty in (user_profile.preferred_subspecialties or [])
                  %}selected{% endif %}>
                  {{ subspecialty.replace('_', ' ').title() }}
                </option>
                {% endfor %}
              </select>
              <small class="form-text text-muted">Hold Ctrl (Windows) or Cmd (Mac) to select multiple.</small>
            </div>

            <div class="mb-3">
              <label for="preferred_workplaces" class="form-label">Preferred Workplaces</label>
              <input type="text" id="preferred_workplaces" name="preferred_workplaces" class="form-control"
                value="{{ ', '.join(user_profile.preferred_workplaces or []) }}"
                placeholder="e.g., NHS, Everlight, TMC">
              <small class="form-text text-muted">Comma-separated values</small>
            </div>

            <button type="submit" class="btn btn-outline-primary">üíæ Save Preferences</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Session Tracker -->
    <div class="col-md-6 ">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0 text-primary">‚è±Ô∏è Session Tracker</h5>
        </div>
        <div class="card-body text-center">
          <p class="text-muted">Click the button to start or end your session. Sessions will auto-end after 8 hours.</p>
          <div class="mb-3">
            <button class="btn btn-success" id="sessionToggleBtn">‚ñ∂Ô∏è Start Session</button>
          </div>
          <div id="sessionTimer" class="fw-bold text-secondary">No session running</div>
        </div>
      </div>
      <div class="card shadow-sm mt-4">
  <div class="card-header bg-light">
    <h5 class="mb-0 text-info">üìä Yesterday‚Äôs Output</h5>
  </div>
  <div class="card-body">
    {% if yesterday_logs %}
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th>Time</th>
            <th>Modality</th>
            <th>Workplace</th>
            <th>Cases</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          {% for log in yesterday_logs %}
          <tr>
            <td>{{ log.session_start_time.strftime('%H:%M') }}</td>
            <td>{{ log.modalities_handled[0].value if log.modalities_handled else '‚Äî' }}</td>
            <td>{{ log.session_type.title() }}</td>
            <td>{{ log.num_cases_reported }}</td>
            <td>{{ log.notes or '‚Äî' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No productivity logs found for yesterday.</p>
    {% endif %}
  </div>
</div>
{% if yesterday_logs %}
  <canvas id="modalityChart" width="400" height="200" class="mt-4"></canvas>
  <script>
    const counts = {};

    {% for log in yesterday_logs %}
      {% if log.modalities_handled %}
        const mod = "{{ log.modalities_handled[0].value }}";
        counts[mod] = (counts[mod] || 0) + {{ log.num_cases_reported }};
      {% endif %}
    {% endfor %}

    const labels = Object.keys(counts);
    const data = Object.values(counts);

    new Chart(document.getElementById('modalityChart'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Cases by Modality',
          data: data,
          backgroundColor: '#4f83cc'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>
{% endif %}
<div class="card shadow-sm mt-4">
  <div class="card-header bg-light">
    <h5 class="mb-0 text-success">üìÖ Today‚Äôs Output</h5>
  </div>
  <div class="card-body">
    {% if today_logs %}
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th>Time</th>
            <th>Modality</th>
            <th>Workplace</th>
            <th>Cases</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          {% for log in today_logs %}
          <tr>
            <td>{{ log.session_start_time.strftime('%H:%M') }}</td>
            <td>{{ log.modalities_handled[0].value if log.modalities_handled else '‚Äî' }}</td>
            <td>{{ log.session_type.title() }}</td>
            <td>{{ log.num_cases_reported }}</td>
            <td>{{ log.notes or '‚Äî' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No productivity logs submitted today.</p>
    {% endif %}
  </div>
</div>

      <!-- Session Details Form (Hidden Initially) -->
      <div class="card shadow-sm mb-4 d-none" id="sessionDetailsCard">
        <div class="card-header bg-light">
          <h6 class="mb-0 text-secondary">üìã Session Summary & Case Logging</h6>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('app_user.save_session_log') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div id="caseBatchContainer">
              <!-- Batch forms will be inserted here dynamically -->
            </div>
            <button type="button" class="btn btn-outline-secondary mt-3" id="addBatchBtn">‚ûï Add Another Batch</button>
            <button type="submit" class="btn btn-primary mt-3">‚úÖ Submit Log</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% if today_logs %}
  <canvas id="todayChart" width="400" height="200" class="mt-4"></canvas>
  <script>
    const todayCounts = {};

    {% for log in today_logs %}
      {% if log.modalities_handled %}
        const mod = "{{ log.modalities_handled[0].value }}";
        todayCounts[mod] = (todayCounts[mod] || 0) + {{ log.num_cases_reported }};
      {% endif %}
    {% endfor %}

    new Chart(document.getElementById('todayChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(todayCounts),
        datasets: [{
          label: 'Today\'s Cases',
          data: Object.values(todayCounts),
          backgroundColor: '#198754'  // green
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>
{% endif %}

<script>
  let isSessionRunning = false;
  let startTime;
  const toggleBtn = document.getElementById('sessionToggleBtn');
  const timerDisplay = document.getElementById('sessionTimer');
  const detailsCard = document.getElementById('sessionDetailsCard');
  const batchContainer = document.getElementById('caseBatchContainer');

  toggleBtn.addEventListener('click', () => {
    isSessionRunning = !isSessionRunning;
    if (isSessionRunning) {
      startTime = new Date();
      toggleBtn.classList.replace('btn-success', 'btn-danger');
      toggleBtn.innerHTML = '‚èπÔ∏è End Session';
      timerDisplay.innerText = `Session started at: ${startTime.toLocaleTimeString()}`;
    } else {
      const endTime = new Date();
      toggleBtn.classList.replace('btn-danger', 'btn-success');
      toggleBtn.innerHTML = '‚ñ∂Ô∏è Start Session';
      timerDisplay.innerText = `Session ended at: ${endTime.toLocaleTimeString()}`;
      detailsCard.classList.remove('d-none');
      addCaseBatchForm();
    }
  });

  function addCaseBatchForm() {
    const batchHTML = `
      <div class="border rounded p-3 mb-3">
        <div class="mb-2">
          <label class="form-label">Number of Cases</label>
          <input type="number" name="cases[]" class="form-control" required />
        </div>
        <div class="mb-2">
          <label class="form-label">Modality</label>
          <select name="modalities[]" class="form-select">
            <option>CT</option>
            <option>MRI</option>
            <option>X-ray</option>
            <option>Ultrasound</option>
            <option>Others</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Workplace</label>
          <select name="workplaces[]" class="form-select">
            <option>NHS</option>
            <option>Teleradiology</option>
            <option>Private</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Notes (optional)</label>
          <textarea name="notes[]" class="form-control" rows="2"></textarea>
        </div>
      </div>
    `;
    batchContainer.insertAdjacentHTML('beforeend', batchHTML);
  }

  document.getElementById('addBatchBtn').addEventListener('click', () => {
    addCaseBatchForm();
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}