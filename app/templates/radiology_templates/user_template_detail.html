{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-1">
            {% if case_workspace_url is defined and case_workspace_url %}
            <li class="breadcrumb-item">
                <a href="{{ case_workspace_url }}">Case Workspace</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('app_user.list_user_templates') }}">My templates</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {{ template_title }}
            </li>
        </ol>
    </nav>
    <h1 class="h3">{{ template_title }}</h1>
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
        <div>
            <a href="{{ url_for('app_user.list_user_templates') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> View all templates
            </a>
        </div>
        {% if admin_templates is defined %}
        <div class="d-flex align-items-center gap-2">
            <label for="admin_template_select" class="form-label mb-0 small text-muted">
                Browse admin templates:
            </label>
            <select id="admin_template_select" class="form-select form-select-sm" style="min-width: 260px;">
                <option value="">Select admin template…</option>
                {% for t in admin_templates %}
                <option value="{{ url_for('content_routes.get_template', template_id=t.id) }}"
                        {% if admin_templates and admin_templates.id == t.id %}selected{% endif %}>
                    {{ t.template_name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    {# Section-driven report body #}
    {% if sections %}
    <div class="row">
        <div class="col-12">
            {% for section in sections %}
            {% set sec_id = section.id %}
            {% set label = section.label or sec_id|replace('_', ' ')|title %}
            {% set value = section_values.get(sec_id, section.default_text or '') %}
            <div class="card mb-3">
                <div class="card-header fw-semibold">
                    {{ label }}
                </div>
                <div class="card-body">
                    <div class="section-rendered text-start" data-section-id="{{ sec_id }}">
                        {% if value %}
                        <pre class="mb-0 small">{{ value }}</pre>
                        {% else %}
                        <span class="text-muted small">No content yet.</span>
                        {% endif %}
                    </div>
                    <textarea class="d-none section-raw" data-section-id="{{ sec_id }}">{{ value }}</textarea>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mt-3">
        No sections defined for this template. Please check the template definition in WSCompanion admin.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script>
(function () {
    function attachAdminTemplateSelector() {
        const select = document.getElementById('admin_template_select');
        if (!select) {
            return;
        }
        select.addEventListener('change', function () {
            if (this.value) {
                window.location.href = this.value;
            }
        });
    }

    function escapeHtml(str) {
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatSectionText(raw) {
        if (!raw) {
            return "";
        }
        const lines = raw.split(/\r?\n/);
        const htmlParts = [];
        let currentPara = [];
        let inList = false;

        function flushPara() {
            if (currentPara.length) {
                const text = escapeHtml(currentPara.join(" "));
                htmlParts.push('<p class="mb-1 small">' + text + '</p>');
                currentPara = [];
            }
        }

        function startList() {
            if (!inList) {
                htmlParts.push('<ul class="mb-1 ps-4 small">');
                inList = true;
            }
        }

        function endList() {
            if (inList) {
                htmlParts.push('</ul>');
                inList = false;
            }
        }

        lines.forEach(function (line) {
            const trimmed = line.trim();
            if (!trimmed) {
                // blank line: end paragraph and list
                flushPara();
                endList();
                return;
            }

            if (/^[-•]/.test(trimmed)) {
                // bullet point
                flushPara();
                startList();
                const itemText = escapeHtml(trimmed.replace(/^[-•]\s*/, ""));
                htmlParts.push("<li>" + itemText + "</li>");
            } else {
                // part of a paragraph
                endList();
                currentPara.push(trimmed);
            }
        });

        flushPara();
        endList();

        return htmlParts.join("\n");
    }

    function applyPlaceholderHighlight(html) {
        if (!html) {
            return html;
        }
        // Highlight [placeholder] segments in the rendered HTML
        return html.replace(/\[([^\]]+)\]/g, '<span class="placeholder-highlight">[$1]</span>');
    }

    function renderSections() {
        const raws = document.querySelectorAll(".section-raw");
        raws.forEach(function (textarea) {
            const secId = textarea.getAttribute("data-section-id");
            const target = document.querySelector('.section-rendered[data-section-id="' + secId + '"]');
            if (!target) {
                return;
            }
            const raw = textarea.value || "";
            const formatted = formatSectionText(raw);
            if (formatted) {
                target.innerHTML = applyPlaceholderHighlight(formatted);
            } else {
                target.innerHTML = '<span class="text-muted small">No content yet.</span>';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        attachAdminTemplateSelector();
        renderSections();
    });
})();
</script>
<style>
.placeholder-highlight {
    background-color: rgba(255, 215, 0, 0.4);
    padding: 0 2px;
    border-radius: 2px;
}
</style>
{% endblock %}