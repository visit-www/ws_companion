{# templates/measurements/index.html #}
{% extends "base.html" %}

{% block title %}Radiology Measurement Library{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="row">
    <div class="col-12 col-lg-8 mx-auto">
      <h1 class="h3 mb-3">Radiology Measurement Library</h1>
      <p class="text-muted">
        Start typing a measurement (e.g. "appendix", "CBD", "main PA") or filter by body part / modality.
      </p>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="mb-3 position-relative">
            <label for="measurement-search" class="form-label">Search measurements</label>
            <input id="measurement-search" type="text" class="form-control"
                   placeholder="Type at least 2 letters…">
            <div id="measurement-suggestions"
                 class="list-group position-absolute w-100 shadow-sm"
                 style="z-index: 1050; display: none; max-height: 260px; overflow-y: auto;">
              <!-- JS injects suggestions -->
            </div>
          </div>

          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label class="form-label">Body part</label>
              <select id="filter-body-part" class="form-select">
                <option value="">Any</option>
                {% for bp in BodyPartEnum %}
                  <option value="{{ bp.value }}">{{ bp.value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Modality</label>
              <select id="filter-modality" class="form-select">
                <option value="">Any</option>
                {% for mod in ModalityEnum %}
                  <option value="{{ mod.value }}">{{ mod.value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Diagnosis / tag</label>
              <input id="filter-diagnosis" class="form-control"
                     placeholder="e.g. appendicitis, PE, aneurysm">
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-end">
            <button id="search-btn" class="btn btn-primary">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
        </div>
      </div>

      <div id="results-summary" class="mb-2 text-muted" style="display:none;"></div>

      <div id="measurement-results" class="row g-3">
        <!-- JS injects result cards here -->
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const searchInput = document.getElementById('measurement-search');
  const suggestionsEl = document.getElementById('measurement-suggestions');
  const resultsEl = document.getElementById('measurement-results');
  const summaryEl = document.getElementById('results-summary');

  const bodyPartEl = document.getElementById('filter-body-part');
  const modalityEl = document.getElementById('filter-modality');
  const diagnosisEl = document.getElementById('filter-diagnosis');
  const searchBtn = document.getElementById('search-btn');

  let debounceTimer = null;

  function buildQuery(limit) {
    const params = new URLSearchParams();
    const q = searchInput.value.trim();
    const bp = bodyPartEl.value;
    const mod = modalityEl.value;
    const diag = diagnosisEl.value.trim();

    if (q) params.set('q', q);
    if (bp) params.set('body_part', bp);
    if (mod) params.set('modality', mod);
    if (diag) params.set('diagnosis', diag);
    if (limit) params.set('limit', limit);

    return params.toString() ? ('?' + params.toString()) : '';
  }

  function renderSuggestions(results) {
    if (!results.length || searchInput.value.trim().length < 2) {
      suggestionsEl.style.display = 'none';
      suggestionsEl.innerHTML = '';
      return;
    }
    suggestionsEl.innerHTML = '';
    results.forEach(m => {
      const a = document.createElement('a');
      a.href = m.url;
      a.className = 'list-group-item list-group-item-action';
      a.innerHTML = `
        <div class="d-flex justify-content-between">
          <div>
            <strong>${m.name}</strong><br>
            <small class="text-muted">${m.body_part || ''} · ${m.modality || ''}</small>
          </div>
          <div class="text-end">
            <small>${m.display_range || ''}</small>
          </div>
        </div>
      `;
      suggestionsEl.appendChild(a);
    });
    suggestionsEl.style.display = 'block';
  }

  function renderResults(results) {
    resultsEl.innerHTML = '';
    if (!results.length) {
      summaryEl.style.display = 'block';
      summaryEl.textContent = 'No measurements found. Try a different term or filters.';
      return;
    }
    summaryEl.style.display = 'block';
    summaryEl.textContent = `${results.length} measurement(s) found.`;

    results.forEach(m => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';

      col.innerHTML = `
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${m.name}</h5>
            <h6 class="card-subtitle mb-2 text-muted">
              ${m.body_part || ''} · ${m.modality || ''}
            </h6>
            <p class="mb-1"><strong>Normal:</strong> ${m.display_range || ''}</p>
            ${m.age_group || m.sex ? `
              <p class="mb-1">
                <small class="text-muted">
                  ${m.age_group || ''}${m.age_group && m.sex ? ' · ' : ''}${m.sex || ''}
                </small>
              </p>` : ''}
            ${m.context ? `
              <p class="mt-2 mb-3 small text-muted">
                ${m.context.length > 140 ? m.context.slice(0, 140) + '…' : m.context}
              </p>` : ''}
            <div class="mt-auto">
              <a href="${m.url}" class="btn btn-sm btn-outline-primary">View details</a>
            </div>
          </div>
        </div>
      `;
      resultsEl.appendChild(col);
    });
  }

  async function fetchResults(limit) {
    const query = buildQuery(limit);
    const resp = await fetch('/measurements/api/search' + query);
    if (!resp.ok) return {results: []};
    return resp.json();
  }

  async function handleAutocomplete() {
    const q = searchInput.value.trim();
    if (q.length < 2) {
      renderSuggestions([]);
      return;
    }
    const data = await fetchResults(10);
    renderSuggestions(data.results || []);
  }

  async function handleFullSearch() {
    const data = await fetchResults(200);
    renderSuggestions([]); // hide suggestions
    renderResults(data.results || []);
  }

  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(handleAutocomplete, 200);
  });

  searchInput.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      handleFullSearch();
    }
  });

  searchBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    handleFullSearch();
  });

  [bodyPartEl, modalityEl, diagnosisEl].forEach(el => {
    el.addEventListener('change', () => {
      handleFullSearch();
    });
  });

  document.addEventListener('click', (ev) => {
    if (!suggestionsEl.contains(ev.target) && ev.target !== searchInput) {
      suggestionsEl.style.display = 'none';
    }
  });
})();
</script>
{% endblock %}