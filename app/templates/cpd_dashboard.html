{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show pastel-bg" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  {% endwith %}

  {% if saved_cycles %}
  <div class="mb-4 d-flex justify-content-between align-items-center">
    {% if saved_cycles|length > 1 %}
      <div class="input-group w-auto pastel-border">
        <label class="input-group-text pastel-bg border-0" for="cycleSelect">
          <i class="bi bi-calendar3"></i> Appraisal Cycle
        </label>
        <select class="form-select pastel-select" id="cycleSelect" onchange="confirmCycleSwitch(this.value)">
          {% for cycle in saved_cycles %}
            <option value="{{ cycle.id }}" {% if cpd_state and cpd_state.id == cycle.id %}selected{% endif %}>
              {{ cycle.appraisal_cycle_start }} → {{ cycle.appraisal_cycle_end }}
            </option>
          {% endfor %}
        </select>
      </div>
    {% endif %}

    <a href="{{ url_for('app_user.cpd_dashboard') }}?new_cycle=true" class="btn btn-outline-primary">
      <i class="bi bi-plus-circle-fill"></i> New Appraisal Cycle
    </a>
    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#appraisalInfoModal">
      <i class="bi bi-info-circle-fill"></i> What is Appraisal Cycle?
    </button>
  </div>
{% endif %}


  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-journal-medical me-2"></i>CPD Dashboard</h2>
    {% if not cpd_state %}
    {% endif %}
  </div>


  {% if not cpd_state %}
    <div class="alert alert-info shadow-sm">
      <strong>Welcome!</strong> Set your appraisal cycle to begin logging CPD.
    </div>

    <form method="POST" action="{{ url_for('app_user.cpd_dashboard', new_cycle='true') }}" class="card p-4 shadow-sm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="appraisal_cycle_start" class="form-label">Appraisal Cycle Start</label>
            <input type="date" class="form-control" id="appraisal_cycle_start" name="appraisal_cycle_start" required>
          </div>
        <div class="col-md-6">
            <label for="appraisal_cycle_end" class="form-label">Appraisal Cycle End</label>
            <input type="date" class="form-control" id="appraisal_cycle_end" name="appraisal_cycle_end" required>

        </div>
      </div>
      <div class="mt-4 text-end">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-circle me-1"></i>Save Appraisal Cycle
        </button>
      </div>
    </form>

  {% else %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-calendar-check me-2"></i>Appraisal Cycle:</h5>
        <p>{{ cpd_state.appraisal_cycle_start }} → {{ cpd_state.appraisal_cycle_end }}</p>
        <p><strong>Current Appraisal Year:</strong> {{ cpd_state.current_cpd_year_start }} → {{ cpd_state.current_cpd_year_end }}</p>
      </div>
    </div>

    <div class="row text-center mb-4">
      <div class="col-md-4 mb-3">
        <div class="card border-success shadow-sm">
          <div class="card-body">
            <h5 class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Current Year CPD</h5>
            <p class="fs-4 mb-0">{{ total_current }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card border-info shadow-sm">
          <div class="card-body">
            <h5 class="text-info"><i class="bi bi-archive-fill me-1"></i>Previous Years CPD</h5>
            <p class="fs-4 mb-0">{{ total_previous }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card border-warning shadow-sm">
          <div class="card-body">
            <h5 class="text-warning"><i class="bi bi-bullseye me-1"></i>Remaining to Target (250)</h5>
            <p class="fs-4 mb-0">{{ remaining }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <a href="{{ url_for('app_user.cpd_add') }}" class="btn btn-primary mb-2">
        <i class="bi bi-plus-circle me-1"></i>Add CPD Activity
      </a>
      <a href="{{ url_for('app_user.export_cpd_log') }}" class="btn btn-outline-secondary mb-2">
        <i class="bi bi-box-arrow-up-right me-1"></i>Export This Year’s Log
      </a>
    </div>

    <h4 class="mt-4 mb-3"><i class="bi bi-journals me-2"></i>Current Appraisal Year CPD Entries</h4>
    {% if current_year_logs %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Activity Type</th>
              <th>RCR Recommended</th>
              <th>Claimed</th>
              <th>Reflection</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for log in current_year_logs %}
            <tr>
              <td>{{ log.title }}</td>
              <td>{{ log.activity_type.name }}</td>
              <td>{{ log.cpd_points_guideline or "-" }}</td>
              <td>{{ log.cpd_points_claimed or 0 }}</td>
              <td>{{ "Yes" if log.has_reflection else "No" }}</td>
              <td>{{ (log.cpd_points_claimed or 0) + (1 if log.has_reflection else 0) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-warning">No CPD entries found for the current year.</div>
    {% endif %}

    <h4 class="mt-5 mb-3"><i class="bi bi-archive me-2"></i>CPD from Previous Years</h4>
    {% if previous_year_logs %}
      <ul class="list-group">
        {% for log in previous_year_logs %}
          <li class="list-group-item">
            <i class="bi bi-chevron-right me-2"></i>{{ log.title }} — {{ log.cpd_year_start }} → {{ log.cpd_year_end }} | {{ log.cpd_points_claimed or 0 }} pts
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-secondary">No previous years’ CPD recorded yet.</div>
    {% endif %}
  {% endif %}

</div>

<!-- Modal confirmation -->
<div class="modal fade" id="confirmSwitchModal" tabindex="-1" aria-labelledby="confirmSwitchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content pastel-bg shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmSwitchModalLabel"><i class="bi bi-exclamation-triangle-fill text-warning"></i> Switch Cycle?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Switching will reload the page to show the selected appraisal cycle. Continue?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSwitchBtn">Yes, Switch</button>
      </div>
    </div>
  </div>
</div>

{% include "modal_embed_code.html" %}
{% endblock %}

<script>
  let pendingCycleId = null;

  function confirmCycleSwitch(cycleId) {
    pendingCycleId = cycleId;
    const modal = new bootstrap.Modal(document.getElementById('confirmSwitchModal'));
    modal.show();
  }

  document.getElementById('confirmSwitchBtn')?.addEventListener('click', function () {
    if (pendingCycleId) {
      const url = new URL(window.location.href);
      url.searchParams.set('cycle_id', pendingCycleId);
      window.location.href = url.toString();
    }
  });
</script>
